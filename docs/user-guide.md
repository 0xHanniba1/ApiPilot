# ApiPilot 用户使用手册

本手册将帮助您快速上手使用 ApiPilot 平台进行 API 自动化测试。

## 目录

1. [快速入门](#快速入门)
2. [项目管理](#项目管理)
3. [环境配置](#环境配置)
4. [模块管理](#模块管理)
5. [用例管理](#用例管理)
6. [测试集](#测试集)
7. [定时任务](#定时任务)
8. [执行与报告](#执行与报告)
9. [常见问题](#常见问题)

---

## 快速入门

### 完整测试流程

1. **创建项目** - 在项目管理中新建一个测试项目
2. **配置环境** - 为项目添加测试环境（开发、测试、生产等）
3. **创建模块** - 按业务功能划分模块
4. **编写用例** - 在模块下创建测试用例
5. **执行测试** - 单个用例调试或批量执行
6. **查看报告** - 分析执行结果和统计数据

---

## 项目管理

### 创建项目

1. 进入「项目管理」页面
2. 点击「新建项目」按钮
3. 填写项目信息：
   - **项目名称**：必填，项目的唯一标识
   - **项目描述**：选填，描述项目用途

### 项目列表

项目列表展示所有项目的基本信息：
- 项目名称
- 环境数量
- 用例数量
- 创建时间

支持按项目名称搜索筛选。

### 项目详情

点击项目名称进入项目详情页，包含：
- **基本信息**：项目名称、描述、统计数据
- **环境配置**：管理项目的测试环境
- **模块树**：按层级组织的模块结构
- **用例列表**：项目下的所有测试用例

---

## 环境配置

环境用于定义不同测试场景的基础配置，如开发环境、测试环境、生产环境等。

### 创建环境

在项目详情页的「环境配置」标签：

1. 点击「添加环境」
2. 填写环境信息：
   - **环境名称**：如 "开发环境"、"测试环境"
   - **Base URL**：接口的基础地址，如 `https://api.example.com`
   - **默认环境**：是否设为项目默认环境

### 环境变量

环境变量用于存储公共数据，在用例中通过 `{{variable_name}}` 引用：

```
# 环境变量示例
token: eyJhbGciOiJIUzI1NiIs...
user_id: 12345
api_version: v1
```

在用例中使用：
- Headers: `Authorization: Bearer {{token}}`
- Path: `/api/{{api_version}}/users/{{user_id}}`

---

## 模块管理

模块用于按业务功能组织测试用例，支持多级嵌套。

### 创建模块

1. 在项目详情页的模块树区域
2. 点击「新建模块」或在父模块上右键选择「添加子模块」
3. 填写模块名称和描述

### 模块结构示例

```
用户管理
├── 用户注册
├── 用户登录
└── 用户信息
    ├── 查询用户
    └── 更新用户

订单管理
├── 创建订单
├── 查询订单
└── 取消订单
```

---

## 用例管理

### 创建用例

1. 在项目详情页点击模块
2. 点击「新建用例」按钮
3. 进入用例编辑页面

### 用例编辑

用例编辑页面分为多个区域：

#### 基本信息
- **用例名称**：描述测试目的
- **请求方法**：GET、POST、PUT、DELETE、PATCH
- **请求路径**：接口路径，如 `/api/users`

#### Headers 配置
添加请求头，常见示例：
```
Content-Type: application/json
Authorization: Bearer {{token}}
Accept: application/json
```

#### Params 配置
URL 查询参数：
```
page: 1
page_size: 20
status: active
```

#### Body 配置
请求体支持多种格式：
- **none**：无请求体
- **json**：JSON 格式
- **form**：表单格式
- **form-data**：文件上传
- **raw**：原始文本

JSON Body 示例：
```json
{
  "username": "testuser",
  "password": "123456",
  "email": "test@example.com"
}
```

#### 断言配置

断言用于验证响应结果，支持多种类型：

| 类型 | 说明 | 表达式示例 |
|------|------|-----------|
| status_code | 状态码 | status_code |
| json_path | JSON 路径 | $.data.id |
| header | 响应头 | Content-Type |
| response_time | 响应时间 | response_time |
| contains | 包含文本 | response_body |

操作符：
- `eq`：等于
- `ne`：不等于
- `gt`：大于
- `lt`：小于
- `gte`：大于等于
- `lte`：小于等于
- `contains`：包含
- `not_contains`：不包含
- `regex`：正则匹配

示例：
```
类型: json_path
表达式: $.code
操作符: eq
期望值: 0
```

#### 变量提取

从响应中提取变量供后续用例使用：

```
变量名: user_token
来源: body
表达式: $.data.token
```

在后续用例中使用 `{{user_token}}` 引用。

#### 前后置脚本

支持 JavaScript 脚本：

**前置脚本**（请求前执行）：
```javascript
// 生成时间戳
pm.variables.set("timestamp", Date.now());

// 生成随机字符串
pm.variables.set("random_id", Math.random().toString(36).substring(7));
```

**后置脚本**（响应后执行）：
```javascript
// 提取并存储 token
const response = pm.response.json();
if (response.data && response.data.token) {
    pm.variables.set("access_token", response.data.token);
}
```

### 调试执行

点击「调试」按钮可立即执行用例，查看：
- 请求详情（URL、Headers、Body）
- 响应详情（状态码、Headers、Body）
- 断言结果
- 提取的变量

---

## 测试集

测试集用于组织多个用例，按顺序或并行执行。

### 创建测试集

1. 进入「测试集」页面
2. 点击「新建测试集」
3. 选择所属项目和执行模式

### 执行模式

- **顺序执行**：按添加顺序依次执行，支持变量传递
- **并行执行**：同时执行所有用例，提高执行效率

### 添加用例

在测试集编辑页面：
1. 从右侧用例列表选择用例
2. 拖拽调整执行顺序
3. 点击保存

---

## 定时任务

定时任务用于自动执行测试集。

### 创建定时任务

1. 进入「定时任务」页面
2. 点击「新建任务」
3. 配置任务信息

### Cron 表达式

Cron 表达式格式：`秒 分 时 日 月 周`

常用示例：
| 表达式 | 说明 |
|--------|------|
| `0 0 8 * * *` | 每天 8:00 |
| `0 0 0 * * *` | 每天 0:00 |
| `0 0 * * * *` | 每小时整点 |
| `0 */30 * * * *` | 每 30 分钟 |
| `0 0 8 * * 1-5` | 工作日 8:00 |
| `0 0 10 * * 1` | 每周一 10:00 |

### 可视化配置

支持可视化配置执行周期：
- 每天指定时间
- 每周指定日期和时间
- 每月指定日期和时间
- 每隔指定分钟/小时

### 通知配置

支持多种通知方式：
- **邮件**：执行结果发送到指定邮箱
- **Webhook**：发送到自定义 URL
- **钉钉**：发送到钉钉群机器人
- **企业微信**：发送到企微群机器人

可选择通知时机：
- 每次执行后通知
- 仅失败时通知
- 仅成功时通知

---

## 执行与报告

### 执行历史

「执行历史」页面展示所有执行记录：
- 执行内容（用例/测试集名称）
- 所属项目
- 执行状态
- 通过率
- 执行时间
- 耗时

支持按项目、状态、时间范围筛选。

### 执行详情

点击执行记录查看详情：

#### 概览信息
- 执行状态（通过/失败/运行中）
- 总用例数、通过数、失败数
- 执行耗时
- 执行时间

#### 用例结果列表
每个用例的执行结果：
- 用例名称
- 执行状态
- 耗时
- 断言结果

#### 详细信息
点击用例查看：
- 请求信息（URL、Method、Headers、Body）
- 响应信息（Status、Headers、Body）
- 断言结果（每条断言的通过/失败状态）
- 提取的变量

---

## 常见问题

### Q: 变量如何跨用例传递？

A: 在测试集中使用「顺序执行」模式，前一个用例通过「变量提取」提取的变量可以在后续用例中使用。

### Q: 如何处理登录态？

A:
1. 创建登录用例，配置变量提取获取 token
2. 后续用例在 Headers 中使用 `Authorization: Bearer {{token}}`
3. 将登录用例放在测试集的第一位

### Q: 断言失败如何排查？

A:
1. 查看执行详情中的实际响应
2. 检查断言表达式是否正确
3. 确认期望值是否匹配
4. 使用调试功能单独测试用例

### Q: 如何测试文件上传接口？

A:
1. Body 类型选择 `form-data`
2. 添加 file 类型参数
3. 配置文件路径

### Q: 定时任务没有执行怎么办？

A:
1. 检查任务是否已启用
2. 确认 Cron 表达式是否正确
3. 查看 Celery Worker 日志排查问题

---

如有其他问题，欢迎提交 Issue 反馈。
